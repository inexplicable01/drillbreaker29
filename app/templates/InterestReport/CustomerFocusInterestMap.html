<!-- Marker + zone styles -->
<style>
    /* Base numbered marker layout */
    .numbered-marker .pin {
        width: 30px;
        height: 42px;
        border-radius: 16px;
        background: #3b82f6; /* default blue */
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.4);
        border: 2px solid #ffffff;
    }

    .numbered-marker .pin span {
        line-height: 1;
    }

    /* Customer pins (e.g. blue) */
    .numbered-marker.customer-pin .pin {
        background: #f97316; /* blue */
    }

    /* AI suggestion pins (e.g. orange) */
    .numbered-marker.ai-pin .pin {
        background: #3b82f6; /* orange */
    }

    /* Optional: super-highlight variant if you ever use "ai-pin-highlight" */
    .numbered-marker.ai-pin-highlight .pin {
        background: #26cddc;      /* red */
        border-color: #3b82f6;    /* orange border */
        transform: scale(1.05);
    }

    /* Optional: styling for your zone labels so theyâ€™re readable */
    .zone-label {
        font-size: 11px;
        font-weight: 600;
        color: #111827;
        text-shadow: 0 0 3px rgba(255,255,255,0.9);
    }
</style>


<!-- Include Leaflet and jQuery -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
<script>
    // Initialize Leaflet Map
    var map_forsale = L.map('map_forsale', {scrollWheelZoom: false});

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map_forsale);

    // Function to handle region click
    function handleClick(region) {
        document.getElementById('label').innerHTML = region;

        $.ajax({
            url: '/clickablemap/process',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({region: region}),
            success: function (response) {
                document.getElementById('result').innerHTML = response.message;
            },
            error: function (error) {
                console.error('Error:', error);
            }
        });
    }

    // Convert GeoJSON data (use pre-serialized version if available)
    var geojson_features = {{ geojson_features_json | default(geojson_features | tojson, true) }};
    {#var neighbourhoodsSubs = {{ neighbourhoods_subs | tojson }};#}
    {#var cities = {{ cities | tojson }};#}
    var locationzonenames = {{ locationzonenames | tojson }}
    var forsalehomes_dict = {{ forsalehomes_dict | tojson }}
    var ai_comment_zpid = {{ ai_comment_zpid | tojson }}
    var customerzpid_map_data = {{ customerzpid_map_data | tojson }}
    var ai_suggestion_map_data = {{ ai_suggestion_map_data| tojson }}
    console.log(customerzpid_map_data)

    console.log("Processing GeoJSON Data...");

    // Create a bounding box for fitting the map
    var bounds = L.latLngBounds();

    console.log("locationzonenames:", locationzonenames);
    // Iterate over each GeoJSON feature
    geojson_features.forEach(feature => {
        let {geometry, properties} = feature;

        // Ensure correct coordinate order (Leaflet requires [lat, lon])
        if (geometry.type === "Polygon") {
            geometry.coordinates = geometry.coordinates.map(ring =>
                ring.map(coord => [coord[1], coord[0]])
            );
        } else if (geometry.type === "MultiPolygon") {
            geometry.coordinates = geometry.coordinates.map(polygon =>
                polygon.map(ring =>
                    ring.map(coord => [coord[1], coord[0]])
                )
            );
        }

        let zoneName = properties.S_HOOD || properties.CityName || "Unknown";
        let color = "gray";
        let shouldExtendBounds = false;

        // Determine color based on CityName or Neighborhood
        if (locationzonenames.includes(zoneName)) {
            color = "orange";
            console.log("include zone Name", zoneName)
            shouldExtendBounds = true;
        } else {
            color = "purple";
        }

        // Create the polygon layer
        let poly = null;

        if (geometry.type === "Polygon") {
            // geometry.coordinates = [ [ [lat, lng], [lat, lng], ... ] ]
            poly = L.polygon(geometry.coordinates, {color}).addTo(map_forsale);
        } else if (geometry.type === "MultiPolygon") {
            // geometry.coordinates = [
            //   [ [ [lat, lng], ... ] ],  // polygon 1 rings
            //   [ [ [lat, lng], ... ] ],  // polygon 2 rings
            //   ...
            // ]
            // Leaflet is fine with this nested structure
            poly = L.polygon(geometry.coordinates, {color}).addTo(map_forsale);
        }

// Now poly is the â€œbigâ€ combined shape for both Polygon and MultiPolygon
        if (poly) {
            // Extend bounds once, using the combined bounds
            if (shouldExtendBounds) {
                bounds.extend(poly.getBounds());
            }
            if (locationzonenames.includes(zoneName)) {
                poly.bindTooltip(zoneName, {
                    permanent: true,
                    direction: "center",
                    className: "zone-label"
                }).openTooltip();

            }
            // Single tooltip for the whole shape


            // Single click handler for the whole shape
            poly.on('click', () => handleClick(properties.L_HOOD + ',' + properties.S_HOOD));
        }
    });

    // Always frame to King County
    map_forsale.setView([47.5, -121.8], 9); // King County view

    function getCustomIcon(color) {
        return L.icon({
            iconUrl: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`, // Google Maps-style marker icons
            iconSize: [32, 32],  // Adjust the size
            iconAnchor: [16, 32], // Center the marker at the bottom
            popupAnchor: [0, -30]  // Adjust popup position
        });
    }

    function makeNumberedIcon(n, variant) {
        // variant example: "customer", "ai", "highlight"
        return L.divIcon({
            className: `numbered-marker ${variant || ""}`,
            iconSize: [30, 42],
            iconAnchor: [15, 42],
            popupAnchor: [0, -36],
            html: `<div class="pin"><span>${n}</span></div>`
        });
    }



    customerzpid_map_data.forEach(function (cz, idx) {
        console.log(cz);

        var lat = cz.latitude;
        var lng = cz.longitude;
        if (lat == null || lng == null) return;

        var n = idx + 1;

        var marker = L.marker([lat, lng], {
            icon: makeNumberedIcon(n, "customer-pin")  // ðŸ‘ˆ variant
        }).addTo(map_forsale);

        marker.bindPopup(
            `<b>#${n}</b><br>
             ${cz.streetAddress || ''}<br>
             Price: ${cz.price || ''}`
        );

        marker._customerIndex = n;
    });


    ai_suggestion_map_data.forEach(function (cz, idx) {
        console.log(cz);

        var lat = cz.latitude;
        var lng = cz.longitude;
        if (lat == null || lng == null) return;

        var n = idx + 1;

        var marker = L.marker([lat, lng], {
            icon: makeNumberedIcon(n, "ai-pin")  // ðŸ‘ˆ different variant
        }).addTo(map_forsale);

        marker.bindPopup(
            `<b>#${n}</b><br>
             ${cz.streetAddress || ''}<br>
             Price: ${cz.price || ''}`
        );

        marker._customerIndex = n;
    });
</script>